<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ×œ×™××•×“ ×’××¨× - LMS</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap');
        body { font-family: 'Heebo', sans-serif; user-select: none; }
        .page-btn { transition: all 0.1s; }
        .page-btn:active { transform: scale(0.95); }
        /* ×¡×¨×’×œ ×’×œ×™×œ×” ××•×ª×× */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-gray-800 flex flex-col min-h-screen">
    <div id="root" class="flex-1"></div>

    <script type="text/babel">
        // ==========================================
        // 1. ×”×’×“×¨×•×ª ××¢×¨×›×ª
        // ==========================================
        
        // --- ×—×•×‘×” ×œ×©× ×•×ª ×œ×›×ª×•×‘×ª ×©×œ×š ---
        const API_URL = "https://ubriga.pythonanywhere.com"; 
        
        const { useState, useEffect, useMemo, useRef } = React;

        // ==========================================
        // 2. × ×ª×•× ×™ ×‘×¡×™×¡
        // ==========================================
        const getHebrewNumber = (num) => {
            if (num <= 0) return "";
            const letters = [{v:400,c:'×ª'},{v:300,c:'×©'},{v:200,c:'×¨'},{v:100,c:'×§'},{v:90,c:'×¦'},{v:80,c:'×¤'},{v:70,c:'×¢'},{v:60,c:'×¡'},{v:50,c:'× '},{v:40,c:'×'},{v:30,c:'×œ'},{v:20,c:'×›'},{v:10,c:'×™'},{v:9,c:'×˜'},{v:8,c:'×—'},{v:7,c:'×–'},{v:6,c:'×•'},{v:5,c:'×”'},{v:4,c:'×“'},{v:3,c:'×’'},{v:2,c:'×‘'},{v:1,c:'×'}];
            let str = "", temp = num;
            if (temp === 15) return "×˜×•"; if (temp === 16) return "×˜×–";
            for (let l of letters) { while(temp >= l.v) { str += l.c; temp -= l.v; } }
            return str.length === 1 ? str+"'" : str.slice(0,-1)+'"'+str.slice(-1);
        };

        const generatePages = (cnt) => {
            const p = [];
            for(let i=2; i<cnt+2; i++) {
                const h = getHebrewNumber(i);
                p.push({id:`${i}a`, label:`×“×£ ${h} ×¢"×`});
                p.push({id:`${i}b`, label:`×“×£ ${h} ×¢"×‘`});
            }
            return p;
        };

        const SHAS_DATA = [
            { name: "×–×¨×¢×™×", books: [{n:"×‘×¨×›×•×ª",p:63}] },
            { name: "××•×¢×“", books: [{n:"×©×‘×ª",p:156},{n:"×¢×™×¨×•×‘×™×Ÿ",p:104},{n:"×¤×¡×—×™×",p:120},{n:"×©×§×œ×™×",p:21},{n:"×™×•××",p:87},{n:"×¡×•×›×”",p:55},{n:"×‘×™×¦×”",p:39},{n:"×¨××© ×”×©× ×”",p:34},{n:"×ª×¢× ×™×ª",p:30},{n:"××’×™×œ×”",p:31},{n:"××•×¢×“ ×§×˜×Ÿ",p:28},{n:"×—×’×™×’×”",p:26}] },
            { name: "× ×©×™×", books: [{n:"×™×‘××•×ª",p:121},{n:"×›×ª×•×‘×•×ª",p:111},{n:"× ×“×¨×™×",p:90},{n:"× ×–×™×¨",p:65},{n:"×¡×•×˜×”",p:48},{n:"×’×™×˜×™×Ÿ",p:89},{n:"×§×™×“×•×©×™×Ÿ",p:81}] },
            { name: "× ×–×™×§×™×Ÿ", books: [{n:"×‘×‘× ×§××",p:118},{n:"×‘×‘× ××¦×™×¢×",p:118},{n:"×‘×‘× ×‘×ª×¨×",p:175},{n:"×¡× ×”×“×¨×™×Ÿ",p:112},{n:"××›×•×ª",p:23},{n:"×©×‘×•×¢×•×ª",p:48},{n:"×¢×‘×•×“×” ×–×¨×”",p:75},{n:"×”×•×¨×™×•×ª",p:13}] },
            { name: "×§×“×©×™×", books: [{n:"×–×‘×—×™×",p:119},{n:"×× ×—×•×ª",p:109},{n:"×—×•×œ×™×Ÿ",p:141},{n:"×‘×›×•×¨×•×ª",p:60},{n:"×¢×¨×›×™×Ÿ",p:33},{n:"×ª××•×¨×”",p:33},{n:"×›×¨×™×ª×•×ª",p:27},{n:"××¢×™×œ×”",p:20},{n:"×§×™× ×™×",p:3},{n:"××™×“×•×ª",p:4},{n:"×ª××™×“",p:9}] },
            { name: "×˜×”×¨×•×ª", books: [{n:"× ×™×“×”",p:72}] }
        ];

        // ×—×™×©×•×‘ ×¡×”"×› ×“×¤×™× ×‘×©"×¡ (×œ×¦×•×¨×š ×—×™×©×•×‘×™ ××—×•×–×™× ×’×œ×•×‘×œ×™×™×)
        const TOTAL_SHAS_PAGES = SHAS_DATA.reduce((acc, seder) => acc + seder.books.reduce((bAcc, book) => bAcc + (book.p * 2), 0), 0);

        const INITIAL_TRACKS = [{ id:'shas', title:'×”×©"×¡ ×”×‘×‘×œ×™', sections: SHAS_DATA.map((s,i)=>({ id:`s_${i}`, title:s.name, books:s.books.map((b,bi)=>({ id:`b_${s.name}_${bi}`, title:`××¡×›×ª ${b.n}`, totalCount:b.p, units:generatePages(b.p) })) })) }];

        // ==========================================
        // 3. ×¨×›×™×‘×™ React - ××“××™×Ÿ
        // ==========================================

        const AdminStats = () => {
            const [stats, setStats] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                // 1. ×§×‘×œ×ª ×¨×©×™××ª ××©×ª××©×™×
                fetch(`${API_URL}/api/users`)
                .then(r => r.json())
                .then(async (users) => {
                    // 2. ×¢×‘×•×¨ ×›×œ ××©×ª××©, ×”×‘× ××ª ×”×”×ª×§×“××•×ª ×©×œ×•
                    const promises = users.map(async (u) => {
                        const res = await fetch(`${API_URL}/api/get_progress?user_id=${u.id}`);
                        const data = await res.json();
                        return {
                            ...u,
                            doneCount: data.length, // ××¡×¤×¨ ×“×¤×™× ×©×”×•×©×œ××•
                            percentage: ((data.length / TOTAL_SHAS_PAGES) * 100).toFixed(2)
                        };
                    });
                    const results = await Promise.all(promises);
                    setStats(results);
                    setLoading(false);
                });
            }, []);

            if (loading) return <div className="text-center p-4">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>;

            return (
                <div className="bg-white p-6 rounded-xl border shadow-sm mt-6">
                    <h2 className="text-xl font-bold mb-4">×”×ª×§×“××•×ª ×ª×œ××™×“×™×</h2>
                    <div className="overflow-x-auto">
                        <table className="w-full text-right text-sm">
                            <thead className="bg-gray-100 text-gray-700">
                                <tr>
                                    <th className="p-3 rounded-tr-lg">×©× ×ª×œ××™×“</th>
                                    <th className="p-3">×ª×¤×§×™×“</th>
                                    <th className="p-3">×“×¤×™× ×©× ×œ××“×•</th>
                                    <th className="p-3 rounded-tl-lg">×”×ª×§×“××•×ª ×‘×©"×¡</th>
                                </tr>
                            </thead>
                            <tbody>
                                {stats.map(s => (
                                    <tr key={s.id} className="border-b hover:bg-slate-50 transition">
                                        <td className="p-3 font-medium">{s.username}</td>
                                        <td className="p-3 text-gray-500">{s.role === 'student' ? '×ª×œ××™×“' : s.role === 'admin' ? '×× ×”×œ' : '×× ×”×œ ×§×‘×•×¦×”'}</td>
                                        <td className="p-3 text-blue-600 font-bold">{s.doneCount}</td>
                                        <td className="p-3">
                                            <div className="flex items-center gap-2">
                                                <div className="w-24 bg-gray-200 rounded-full h-2">
                                                    <div className="bg-emerald-500 h-2 rounded-full" style={{width: `${Math.min(s.percentage, 100)}%`}}></div>
                                                </div>
                                                <span className="text-xs">{s.percentage}%</span>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const AdminPanel = () => {
            const [users, setUsers] = useState([]);
            const [formData, setForm] = useState({username:'', password:'', role:'student'});
            const [tab, setTab] = useState('users'); // 'users' or 'stats'

            useEffect(() => { fetch(`${API_URL}/api/users`).then(r=>r.json()).then(setUsers); }, []);

            const addUser = () => {
                if(!formData.username || !formData.password) return;
                fetch(`${API_URL}/api/users`, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify(formData)
                }).then(r=>r.json()).then(d => {
                    if(d.ok) {
                        alert("××©×ª××© × ×•×¡×£ ×‘×”×¦×œ×—×”!");
                        setForm({username:'', password:'', role:'student'});
                        fetch(`${API_URL}/api/users`).then(r=>r.json()).then(setUsers);
                    } else { alert(d.error); }
                });
            };

            return (
                <div>
                    <div className="flex gap-4 mb-4 border-b">
                        <button onClick={()=>setTab('users')} className={`pb-2 px-2 ${tab==='users' ? 'border-b-2 border-blue-600 text-blue-600 font-bold' : 'text-gray-500'}`}>× ×™×”×•×œ ××©×ª××©×™×</button>
                        <button onClick={()=>setTab('stats')} className={`pb-2 px-2 ${tab==='stats' ? 'border-b-2 border-blue-600 text-blue-600 font-bold' : 'text-gray-500'}`}>×“×•×—×•×ª ×”×ª×§×“××•×ª</button>
                    </div>

                    {tab === 'stats' && <AdminStats />}

                    {tab === 'users' && (
                        <div className="bg-white p-6 rounded-xl border shadow-sm">
                            <h2 className="text-xl font-bold mb-4">×”×•×¡×¤×ª ××©×ª××© ×—×“×©</h2>
                            <div className="flex flex-col md:flex-row gap-3 mb-6 bg-slate-50 p-4 rounded-lg">
                                <input className="border p-2 rounded flex-1" placeholder="×©× ××©×ª××©" value={formData.username} onChange={e=>setForm({...formData, username:e.target.value})} />
                                <input className="border p-2 rounded flex-1" placeholder="×¡×™×¡××”" type="password" value={formData.password} onChange={e=>setForm({...formData, password:e.target.value})} />
                                <select className="border p-2 rounded" value={formData.role} onChange={e=>setForm({...formData, role:e.target.value})}>
                                    <option value="student">×ª×œ××™×“</option>
                                    <option value="group_admin">×× ×”×œ ×§×‘×•×¦×”</option>
                                    <option value="admin">××“××™×Ÿ ×¨××©×™</option>
                                </select>
                                <button onClick={addUser} className="bg-emerald-600 text-white px-6 py-2 rounded hover:bg-emerald-700 font-bold">+</button>
                            </div>
                            <h3 className="font-bold mb-2">××©×ª××©×™× ×§×™×™××™×</h3>
                            <table className="w-full text-right text-sm">
                                <thead className="bg-gray-100"><tr><th className="p-2">×©×</th><th className="p-2">×ª×¤×§×™×“</th></tr></thead>
                                <tbody>
                                    {users.map(u => <tr key={u.id} className="border-b"><td className="p-2">{u.username}</td><td className="p-2">{u.role}</td></tr>)}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // 4. ×¨×›×™×‘×™ React - ××¤×œ×™×§×¦×™×” ×¨××©×™×ª
        // ==========================================

        const Footer = () => (
            <footer className="bg-slate-800 text-slate-400 text-center py-4 text-xs mt-auto">
                <p>×¤×•×ª×— ×¢×œ ×™×“×™ OrelAI <a href="mailto:ubriga@gmail.com" className="text-slate-300 hover:text-white underline">ubriga@gmail.com</a></p>
            </footer>
        );

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('student');
            
            const [loginData, setLoginData] = useState({username:'', password:''});
            const [loginError, setLoginError] = useState('');

            const [tracks] = useState(INITIAL_TRACKS);
            const [progress, setProgress] = useState({});
            const [activeTrackId, setTrackId] = useState(INITIAL_TRACKS[0].id);
            const [activeSecId, setSecId] = useState(INITIAL_TRACKS[0].sections[0].id);
            const [activeBookId, setBookId] = useState(INITIAL_TRACKS[0].sections[0].books[0].id);

            const [isDragging, setIsDragging] = useState(false);
            const [dragState, setDragState] = useState(null);

            useEffect(() => {
                if (user) {
                    fetch(`${API_URL}/api/get_progress?user_id=${user.id}`).then(r=>r.json()).then(keys => {
                        const p = {}; keys.forEach(k=>p[k]=true); setProgress(p);
                    });
                }
            }, [user]);

            const activeTrack = tracks.find(t => t.id === activeTrackId);
            const activeSec = activeTrack.sections.find(s => s.id === activeSecId);
            const activeBook = activeSec.books.find(b => b.id === activeBookId);

            const stats = useMemo(() => {
                let gT=0, gD=0, bT=0, bD=0;
                tracks.forEach(t => t.sections.forEach(s => s.books.forEach(b => b.units.forEach(u => {
                    const k = `${t.id}_${b.id}_${u.id}`;
                    gT++; if(progress[k]) gD++;
                    if(b.id===activeBookId) { bT++; if(progress[k]) bD++; }
                }))));
                return {gT,gD,bT,bD};
            }, [progress, activeBookId, tracks]);

            const handleLogin = () => {
                fetch(`${API_URL}/api/login`, {
                    method: 'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify(loginData)
                }).then(r=>r.json()).then(d => {
                    if(d.ok) { setUser(d.user); setLoginError(''); }
                    else { setLoginError(d.error); }
                }).catch(()=>setLoginError("×©×’×™××ª ×ª×§×©×•×¨×ª"));
            };

            const toggle = (unitId, forceState=null) => {
                const key = `${activeTrackId}_${activeBookId}_${unitId}`;
                const newState = forceState !== null ? forceState : !progress[key];
                
                setProgress(prev => ({ ...prev, [key]: newState }));

                fetch(`${API_URL}/api/toggle_page`, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({ user_id:user.id, key, force_state: newState })
                });
            };

            const bulkAction = (state) => {
                if(!confirm(state ? `×œ×¡××Ÿ ××ª ×›×œ ××¡×›×ª ${activeBook.title} ×›× ×œ××“×”?` : `×œ× ×§×•×ª ××ª ×›×œ ×”×¡×™××•× ×™× ×‘××¡×›×ª ${activeBook.title}?`)) return;
                
                const updates = {};
                activeBook.units.forEach(u => {
                    const key = `${activeTrackId}_${activeBookId}_${u.id}`;
                    updates[key] = state;
                    fetch(`${API_URL}/api/toggle_page`, {
                        method:'POST', headers:{'Content-Type':'application/json'},
                        body:JSON.stringify({ user_id:user.id, key, force_state: state })
                    });
                });
                setProgress(prev => ({ ...prev, ...updates }));
            };

            const handleMouseDown = (unitId, currentState) => {
                setIsDragging(true);
                setDragState(!currentState);
                toggle(unitId, !currentState);
            };

            const handleMouseEnter = (unitId) => {
                if (isDragging) {
                    toggle(unitId, dragState);
                }
            };

            const handleMouseUp = () => {
                setIsDragging(false);
                setDragState(null);
            };

            useEffect(() => {
                window.addEventListener('mouseup', handleMouseUp);
                return () => window.removeEventListener('mouseup', handleMouseUp);
            }, []);

            if (!user) {
                return (
                    <div className="flex flex-col min-h-screen">
                        <div className="flex-1 flex items-center justify-center bg-slate-100 p-4">
                            <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center">
                                <h1 className="text-2xl font-bold mb-6 text-blue-800">××¢×¨×›×ª "×¢×¥ ×—×™×™×"</h1>
                                <input 
                                    className="w-full border p-3 rounded-lg mb-3 text-right" 
                                    placeholder="×©× ××©×ª××©" 
                                    value={loginData.username} 
                                    onChange={e=>setLoginData({...loginData, username:e.target.value})}
                                    onKeyDown={e => e.key === 'Enter' && handleLogin()} 
                                />
                                <input 
                                    className="w-full border p-3 rounded-lg mb-3 text-right" 
                                    type="password" 
                                    placeholder="×¡×™×¡××”" 
                                    value={loginData.password} 
                                    onChange={e=>setLoginData({...loginData, password:e.target.value})}
                                    onKeyDown={e => e.key === 'Enter' && handleLogin()} 
                                />
                                <button onClick={handleLogin} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700">×›× ×™×¡×” ×œ××¢×¨×›×ª</button>
                                {loginError && <p className="text-red-500 mt-4 text-sm">{loginError}</p>}
                            </div>
                        </div>
                        <Footer />
                    </div>
                );
            }

            return (
                <div className="flex flex-col min-h-screen select-none">
                    <header className="bg-white border-b sticky top-0 z-20 px-4 py-3 shadow-sm flex justify-between items-center">
                        <div className="flex flex-col">
                            <span className="font-bold text-lg text-blue-900">×¢×¥ ×—×™×™× LMS</span>
                            <span className="text-[10px] text-gray-400">by OrelAI</span>
                        </div>
                        <nav className="flex items-center gap-4">
                            <button onClick={()=>setView('student')} className={`text-sm font-medium ${view==='student'?'text-blue-600':'text-gray-500'}`}>×œ×•×— ×ª×œ××™×“</button>
                            {user.role === 'admin' && (
                                <button onClick={()=>setView('admin')} className={`text-sm font-medium ${view==='admin'?'text-blue-600':'text-gray-500'}`}>× ×™×”×•×œ ××¢×¨×›×ª</button>
                            )}
                            <div className="h-4 w-px bg-gray-300 mx-1"></div>
                            <span className="text-xs font-bold">{user.name}</span>
                            <button onClick={()=>setUser(null)} className="text-red-500" title="×™×¦×™××”">ğŸšª</button>
                        </nav>
                    </header>

                    <main className="max-w-7xl mx-auto p-4 space-y-6 flex-1 w-full">
                        {view === 'admin' && user.role === 'admin' && <AdminPanel />}

                        {view === 'student' && (
                            <React.Fragment>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="bg-white p-5 rounded-xl border shadow-sm">
                                        <div className="text-sm text-gray-500 mb-1">×”×ª×§×“××•×ª ×‘××¡×›×ª {activeBook.title}</div>
                                        <div className="text-2xl font-bold text-blue-600">{stats.bD} / {stats.bT} ×“×¤×™×</div>
                                        <div className="w-full bg-gray-200 h-2 rounded-full mt-2"><div className="bg-blue-600 h-2 rounded-full" style={{width:`${(stats.bD/stats.bT)*100}%`}}></div></div>
                                    </div>
                                    <div className="bg-white p-5 rounded-xl border shadow-sm">
                                        <div className="text-sm text-gray-500 mb-1">× ×•×ª×¨×• ×œ×¡×™×•× ×”×©"×¡</div>
                                        <div className="text-2xl font-bold text-amber-600">{stats.gT - stats.gD} ×“×¤×™×</div>
                                        <div className="w-full bg-gray-200 h-2 rounded-full mt-2"><div className="bg-amber-500 h-2 rounded-full" style={{width:`${(stats.gD/stats.gT)*100}%`}}></div></div>
                                    </div>
                                </div>

                                <div className="bg-white p-4 rounded-xl border shadow-sm flex flex-col sm:flex-row gap-3 sticky top-16 z-10">
                                    <select className="border p-2 rounded-lg flex-1 bg-slate-50" value={activeSecId} onChange={e=>{
                                        const s = activeTrack.sections.find(x=>x.id===e.target.value); setSecId(s.id); setBookId(s.books[0].id);
                                    }}>
                                        {activeTrack.sections.map(s=><option key={s.id} value={s.id}>{s.title}</option>)}
                                    </select>
                                    <select className="border p-2 rounded-lg flex-1 bg-slate-50" value={activeBookId} onChange={e=>setBookId(e.target.value)}>
                                        {activeSec.books.map(b=><option key={b.id} value={b.id}>{b.title}</option>)}
                                    </select>
                                </div>

                                <div className="bg-white p-6 rounded-xl border shadow-sm">
                                    <div className="flex justify-between items-center mb-6 border-b pb-4">
                                        <h2 className="text-xl font-bold">{activeBook.title}</h2>
                                        <div className="flex gap-2">
                                            <button onClick={()=>bulkAction(true)} className="text-xs bg-emerald-100 text-emerald-700 px-3 py-1.5 rounded hover:bg-emerald-200 font-bold">âœ… ×¡×™×™××ª×™ ××¡×›×ª</button>
                                            <button onClick={()=>bulkAction(false)} className="text-xs bg-gray-100 text-gray-600 px-3 py-1.5 rounded hover:bg-gray-200">â™»ï¸ × ×§×” ×”×›×œ</button>
                                        </div>
                                    </div>
                                    <div className="text-xs text-gray-400 mb-2 text-center">× ×™×ª×Ÿ ×œ×’×¨×•×¨ ××ª ×”×¢×›×‘×¨ ×›×“×™ ×œ×¡××Ÿ ×“×¤×™× ×‘×¨×¦×£</div>
                                    <div className="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-3">
                                        {activeBook.units.map(u => {
                                            const k = `${activeTrackId}_${activeBookId}_${u.id}`;
                                            const done = progress[k];
                                            return (
                                                <button 
                                                    key={u.id} 
                                                    onMouseDown={() => handleMouseDown(u.id, done)}
                                                    onMouseEnter={() => handleMouseEnter(u.id)}
                                                    className={`page-btn p-3 rounded-lg border text-sm font-medium ${done ? 'bg-blue-600 text-white border-blue-600 shadow-md transform scale-105' : 'bg-slate-50 text-gray-600 hover:border-blue-400'}`}
                                                >
                                                    {u.label} {done && "âœ“"}
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>
                            </React.Fragment>
                        )}
                    </main>

                    <Footer />
                </div>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
