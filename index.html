<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ×œ×™××•×“ ×’××¨×</title>
    
    <!-- ×˜×¢×™× ×ª ×¨×™××§×˜ ××”×¢× ×Ÿ -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    
    <!-- ×¢×™×¦×•×‘ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap');
        body { font-family: 'Heebo', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // ×”×’×“×¨×•×ª ×—×©×•×‘×•×ª
        // ==========================================
        
        // --- ×©×™× ×›××Ÿ ××ª ×”×›×ª×•×‘×ª ×©×œ×š ×-PYTHONANYWHERE ---
        // ×—×©×•×‘: ×œ×œ× ×œ×•×›×¡×Ÿ ×‘×¡×•×£, ×•×—×™×™×‘ ×œ×”×ª×—×™×œ ×‘-HTTPS
        const API_URL = "https://ubriga.pythonanywhere.com/"; 
        
        const { useState, useEffect, useMemo } = React;

        // ==========================================
        // ×œ×•×’×™×§×” ×¢×¡×§×™×ª (×—×™×©×•×‘×™ ×“×¤×™× ×•×’××˜×¨×™×”)
        // ==========================================

        const getHebrewNumber = (num) => {
            if (num <= 0) return "";
            const letters = [
                { val: 400, char: '×ª' }, { val: 300, char: '×©' }, { val: 200, char: '×¨' },
                { val: 100, char: '×§' }, { val: 90, char: '×¦' }, { val: 80, char: '×¤' },
                { val: 70, char: '×¢' }, { val: 60, char: '×¡' }, { val: 50, char: '× ' },
                { val: 40, char: '×' }, { val: 30, char: '×œ' }, { val: 20, char: '×›' },
                { val: 10, char: '×™' }, { val: 9, char: '×˜' }, { val: 8, char: '×—' },
                { val: 7, char: '×–' }, { val: 6, char: '×•' }, { val: 5, char: '×”' },
                { val: 4, char: '×“' }, { val: 3, char: '×’' }, { val: 2, char: '×‘' }, { val: 1, char: '×' }
            ];
            let str = "", temp = num;
            if (temp === 15) return "×˜×•";
            if (temp === 16) return "×˜×–";
            
            for (let l of letters) {
                while (temp >= l.val) { str += l.char; temp -= l.val; }
            }
            return str.length === 1 ? str + "'" : str.slice(0, -1) + '"' + str.slice(-1);
        };

        const generatePages = (pageCount) => {
            const pages = [];
            for (let i = 2; i < pageCount + 2; i++) {
                const heb = getHebrewNumber(i);
                pages.push({ id: `${i}a`, label: `×“×£ ${heb} ×¢"×` });
                pages.push({ id: `${i}b`, label: `×“×£ ${heb} ×¢"×‘` });
            }
            return pages;
        };

        const SHAS_DATA = [
            { name: "×–×¨×¢×™×", books: [{ n: "×‘×¨×›×•×ª", p: 63 }] },
            { name: "××•×¢×“", books: [{ n: "×©×‘×ª", p: 156 }, { n: "×¢×™×¨×•×‘×™×Ÿ", p: 104 }, { n: "×¤×¡×—×™×", p: 120 }, { n: "×©×§×œ×™×", p: 21 }, { n: "×™×•××", p: 87 }, { n: "×¡×•×›×”", p: 55 }, { n: "×‘×™×¦×”", p: 39 }, { n: "×¨××© ×”×©× ×”", p: 34 }, { n: "×ª×¢× ×™×ª", p: 30 }, { n: "××’×™×œ×”", p: 31 }, { n: "××•×¢×“ ×§×˜×Ÿ", p: 28 }, { n: "×—×’×™×’×”", p: 26 }] },
            { name: "× ×©×™×", books: [{ n: "×™×‘××•×ª", p: 121 }, { n: "×›×ª×•×‘×•×ª", p: 111 }, { n: "× ×“×¨×™×", p: 90 }, { n: "× ×–×™×¨", p: 65 }, { n: "×¡×•×˜×”", p: 48 }, { n: "×’×™×˜×™×Ÿ", p: 89 }, { n: "×§×™×“×•×©×™×Ÿ", p: 81 }] },
            { name: "× ×–×™×§×™×Ÿ", books: [{ n: "×‘×‘× ×§××", p: 118 }, { n: "×‘×‘× ××¦×™×¢×", p: 118 }, { n: "×‘×‘× ×‘×ª×¨×", p: 175 }, { n: "×¡× ×”×“×¨×™×Ÿ", p: 112 }, { n: "××›×•×ª", p: 23 }, { n: "×©×‘×•×¢×•×ª", p: 48 }, { n: "×¢×‘×•×“×” ×–×¨×”", p: 75 }, { n: "×”×•×¨×™×•×ª", p: 13 }] },
            { name: "×§×“×©×™×", books: [{ n: "×–×‘×—×™×", p: 119 }, { n: "×× ×—×•×ª", p: 109 }, { n: "×—×•×œ×™×Ÿ", p: 141 }, { n: "×‘×›×•×¨×•×ª", p: 60 }, { n: "×¢×¨×›×™×Ÿ", p: 33 }, { n: "×ª××•×¨×”", p: 33 }, { n: "×›×¨×™×ª×•×ª", p: 27 }, { n: "××¢×™×œ×”", p: 20 }, { n: "×§×™× ×™×", p: 3 }, { n: "××™×“×•×ª", p: 4 }, { n: "×ª××™×“", p: 9 }] },
            { name: "×˜×”×¨×•×ª", books: [{ n: "× ×™×“×”", p: 72 }] }
        ];

        const INITIAL_TRACKS = [{
            id: 'shas', title: '×”×©"×¡ ×”×‘×‘×œ×™',
            sections: SHAS_DATA.map((s, i) => ({
                id: `s_${i}`, title: `×¡×“×¨ ${s.name}`,
                books: s.books.map((b, bi) => ({
                    id: `b_${s.name}_${bi}`, title: `××¡×›×ª ${b.n}`,
                    totalCount: b.p, units: generatePages(b.p)
                }))
            }))
        }];

        // ==========================================
        // ×¨×›×™×‘×™ UI
        // ==========================================

        const ProgressBar = ({ current, total, color, label }) => {
            const pct = Math.round((current / total) * 100) || 0;
            const colors = { blue: "bg-blue-600", emerald: "bg-emerald-600", amber: "bg-amber-500" };
            return (
                <div className="mb-4">
                    <div className="flex justify-between text-sm mb-1 text-gray-600 font-medium">
                        <span>{label}</span>
                        <span>{pct}% ({current}/{total})</span>
                    </div>
                    <div className="w-full bg-gray-200 rounded-full h-2.5">
                        <div className={`h-2.5 rounded-full transition-all duration-500 ${colors[color]}`} style={{ width: `${pct}%` }}></div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [tracks, setTracks] = useState(INITIAL_TRACKS);
            const [progress, setProgress] = useState({});
            const [activeTrackId, setTrackId] = useState(INITIAL_TRACKS[0].id);
            const [activeSecId, setSecId] = useState(INITIAL_TRACKS[0].sections[0].id);
            const [activeBookId, setBookId] = useState(INITIAL_TRACKS[0].sections[0].books[0].id);

            // ×˜×¢×™× ×ª × ×ª×•× ×™× ××”×©×¨×ª
            useEffect(() => {
                if (user) {
                    fetch(`${API_URL}/api/get_progress?user_id=${user.id}`)
                        .then(r => r.json())
                        .then(keys => {
                            const newProg = {};
                            keys.forEach(k => newProg[k] = true);
                            setProgress(newProg);
                        })
                        .catch(err => console.error("Error fetching:", err));
                }
            }, [user]);

            const activeTrack = tracks.find(t => t.id === activeTrackId);
            const activeSec = activeTrack.sections.find(s => s.id === activeSecId);
            const activeBook = activeSec.books.find(b => b.id === activeBookId);

            const stats = useMemo(() => {
                let gT=0, gD=0, bT=0, bD=0;
                tracks.forEach(t => t.sections.forEach(s => s.books.forEach(b => b.units.forEach(u => {
                    const key = `${t.id}_${b.id}_${u.id}`;
                    const isDone = progress[key];
                    gT++; if(isDone) gD++;
                    if(b.id === activeBookId) { bT++; if(isDone) bD++; }
                }))));
                return { gT, gD, bT, bD };
            }, [progress, activeBookId]);

            const toggle = (unitId) => {
                const key = `${activeTrackId}_${activeBookId}_${unitId}`;
                
                // ×¢×“×›×•×Ÿ ××•×¤×˜×™××™ ×‘×××©×§
                setProgress(prev => ({ ...prev, [key]: !prev[key] }));

                // ×©×œ×™×—×” ×œ×©×¨×ª
                fetch(`${API_URL}/api/toggle_page`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: user.id, key: key })
                });
            };

            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                        <div className="bg-white p-8 rounded-2xl shadow-xl text-center max-w-md w-full">
                            <div className="text-4xl mb-4">ğŸ“–</div>
                            <h1 className="text-2xl font-bold mb-2">××¢×¨×›×ª "×¢×¥ ×—×™×™×"</h1>
                            <p className="text-gray-500 mb-6">×‘×—×¨ ××©×ª××© ×œ×›× ×™×¡×”</p>
                            <button onClick={() => setUser({id: 'student1', name: '×™×•×¡×™ ×›×”×Ÿ', role: 'student'})} className="w-full bg-blue-600 text-white py-3 rounded-lg mb-3 hover:bg-blue-700">×›× ×™×¡×ª ×ª×œ××™×“</button>
                            <button onClick={() => setUser({id: 'admin1', name: '×”×¨×‘ ×œ×•×™', role: 'admin'})} className="w-full bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700">×›× ×™×¡×ª ×× ×”×œ</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-10">
                    <header className="bg-white border-b sticky top-0 z-10 px-4 py-3 flex justify-between items-center shadow-sm">
                        <div className="flex items-center gap-2">
                            <span className="text-2xl">ğŸ“–</span>
                            <span className="font-bold text-xl hidden sm:inline">×¢×¥ ×—×™×™× LMS</span>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="text-left text-sm">
                                <div className="font-bold">{user.name}</div>
                                <div className="text-gray-500">{user.role === 'admin' ? '×× ×”×œ' : '×ª×œ××™×“'}</div>
                            </div>
                            <button onClick={() => setUser(null)} className="text-red-500 text-xl" title="×”×ª× ×ª×§">ğŸšª</button>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-4 space-y-6">
                        {/* ×›×¨×˜×™×¡×™ ×¡×˜×˜×™×¡×˜×™×§×” */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-white p-5 rounded-xl shadow-sm border">
                                <h3 className="font-bold text-gray-700 mb-2">ğŸ“Š ×”×ª×§×“××•×ª ×‘××¡×›×ª {activeBook.title}</h3>
                                <ProgressBar current={stats.bD} total={stats.bT} color="blue" label="×“×¤×™× ×©×”×•×©×œ××•" />
                            </div>
                            <div className="bg-white p-5 rounded-xl shadow-sm border">
                                <h3 className="font-bold text-gray-700 mb-2">ğŸ° ×¡×™×•× ×”×©"×¡</h3>
                                <div className="text-3xl font-bold text-slate-800">
                                    {stats.gT - stats.gD} <span className="text-sm font-normal text-gray-500">×“×¤×™× × ×•×ª×¨×•</span>
                                </div>
                                <ProgressBar current={stats.gD} total={stats.gT} color="amber" label="×¡×”×´×› ×”×•×©×œ××•" />
                            </div>
                        </div>

                        {/* ×¡×¨×’×œ × ×™×•×•×˜ */}
                        <div className="bg-white p-4 rounded-xl shadow-sm border sticky top-20 z-10 flex flex-col md:flex-row gap-4">
                            <select className="bg-slate-50 border p-2.5 rounded-lg w-full" value={activeSecId} onChange={e => {
                                const newS = activeTrack.sections.find(s => s.id === e.target.value);
                                setSecId(e.target.value);
                                setBookId(newS.books[0].id);
                            }}>
                                {activeTrack.sections.map(s => <option key={s.id} value={s.id}>{s.title}</option>)}
                            </select>
                            <select className="bg-slate-50 border p-2.5 rounded-lg w-full" value={activeBookId} onChange={e => setBookId(e.target.value)}>
                                {activeSec.books.map(b => <option key={b.id} value={b.id}>{b.title}</option>)}
                            </select>
                        </div>

                        {/* ×’×¨×™×“ ×“×¤×™× */}
                        <div className="bg-white p-6 rounded-xl shadow-sm border">
                            <h2 className="text-xl font-bold mb-4 border-b pb-2">{activeBook.title}</h2>
                            <div className="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-3">
                                {activeBook.units.map(u => {
                                    const key = `${activeTrackId}_${activeBookId}_${u.id}`;
                                    const isDone = progress[key];
                                    return (
                                        <button key={u.id} onClick={() => toggle(u.id)} className={`
                                            relative p-3 rounded-lg border text-center transition-all duration-200
                                            ${isDone ? 'bg-blue-600 border-blue-600 text-white shadow-md transform scale-105' : 'bg-slate-50 hover:border-blue-400'}
                                        `}>
                                            <div className="text-sm font-medium">{u.label}</div>
                                            {isDone && <div className="absolute -top-2 -right-2 bg-white text-blue-600 rounded-full px-1 shadow text-xs">âœ“</div>}
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
