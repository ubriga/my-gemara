<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת לימוד גמרא - LMS</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap');
        body { font-family: 'Heebo', sans-serif; user-select: none; }
        .page-btn { transition: all 0.1s; }
        .page-btn:active { transform: scale(0.95); }
        /* סרגל גלילה מותאם */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-gray-800 flex flex-col min-h-screen">
    <div id="root" class="flex-1"></div>

    <script type="text/babel">
        // ==========================================
        // 1. הגדרות מערכת
        // ==========================================
        
        // --- חובה לשנות לכתובת שלך ---
        const API_URL = "https://ubriga.pythonanywhere.com"; 
        
        const { useState, useEffect, useMemo, useRef } = React;

        // ==========================================
        // 2. נתוני בסיס
        // ==========================================
        const getHebrewNumber = (num) => {
            if (num <= 0) return "";
            const letters = [{v:400,c:'ת'},{v:300,c:'ש'},{v:200,c:'ר'},{v:100,c:'ק'},{v:90,c:'צ'},{v:80,c:'פ'},{v:70,c:'ע'},{v:60,c:'ס'},{v:50,c:'נ'},{v:40,c:'מ'},{v:30,c:'ל'},{v:20,c:'כ'},{v:10,c:'י'},{v:9,c:'ט'},{v:8,c:'ח'},{v:7,c:'ז'},{v:6,c:'ו'},{v:5,c:'ה'},{v:4,c:'ד'},{v:3,c:'ג'},{v:2,c:'ב'},{v:1,c:'א'}];
            let str = "", temp = num;
            if (temp === 15) return "טו"; if (temp === 16) return "טז";
            for (let l of letters) { while(temp >= l.v) { str += l.c; temp -= l.v; } }
            return str.length === 1 ? str+"'" : str.slice(0,-1)+'"'+str.slice(-1);
        };

        const generatePages = (cnt) => {
            const p = [];
            for(let i=2; i<cnt+2; i++) {
                const h = getHebrewNumber(i);
                p.push({id:`${i}a`, label:`דף ${h} ע"א`});
                p.push({id:`${i}b`, label:`דף ${h} ע"ב`});
            }
            return p;
        };

        const SHAS_DATA = [
            { name: "זרעים", books: [{n:"ברכות",p:63}] },
            { name: "מועד", books: [{n:"שבת",p:156},{n:"עירובין",p:104},{n:"פסחים",p:120},{n:"שקלים",p:21},{n:"יומא",p:87},{n:"סוכה",p:55},{n:"ביצה",p:39},{n:"ראש השנה",p:34},{n:"תענית",p:30},{n:"מגילה",p:31},{n:"מועד קטן",p:28},{n:"חגיגה",p:26}] },
            { name: "נשים", books: [{n:"יבמות",p:121},{n:"כתובות",p:111},{n:"נדרים",p:90},{n:"נזיר",p:65},{n:"סוטה",p:48},{n:"גיטין",p:89},{n:"קידושין",p:81}] },
            { name: "נזיקין", books: [{n:"בבא קמא",p:118},{n:"בבא מציעא",p:118},{n:"בבא בתרא",p:175},{n:"סנהדרין",p:112},{n:"מכות",p:23},{n:"שבועות",p:48},{n:"עבודה זרה",p:75},{n:"הוריות",p:13}] },
            { name: "קדשים", books: [{n:"זבחים",p:119},{n:"מנחות",p:109},{n:"חולין",p:141},{n:"בכורות",p:60},{n:"ערכין",p:33},{n:"תמורה",p:33},{n:"כריתות",p:27},{n:"מעילה",p:20},{n:"קינים",p:3},{n:"מידות",p:4},{n:"תמיד",p:9}] },
            { name: "טהרות", books: [{n:"נידה",p:72}] }
        ];

        // חישוב סה"כ דפים בש"ס (לצורך חישובי אחוזים גלובליים)
        const TOTAL_SHAS_PAGES = SHAS_DATA.reduce((acc, seder) => acc + seder.books.reduce((bAcc, book) => bAcc + (book.p * 2), 0), 0);

        const INITIAL_TRACKS = [{ id:'shas', title:'הש"ס הבבלי', sections: SHAS_DATA.map((s,i)=>({ id:`s_${i}`, title:s.name, books:s.books.map((b,bi)=>({ id:`b_${s.name}_${bi}`, title:`מסכת ${b.n}`, totalCount:b.p, units:generatePages(b.p) })) })) }];

        // ==========================================
        // 3. רכיבי React - אדמין
        // ==========================================

        const AdminStats = () => {
            const [stats, setStats] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                // 1. קבלת רשימת משתמשים
                fetch(`${API_URL}/api/users`)
                .then(r => r.json())
                .then(async (users) => {
                    // 2. עבור כל משתמש, הבא את ההתקדמות שלו
                    const promises = users.map(async (u) => {
                        const res = await fetch(`${API_URL}/api/get_progress?user_id=${u.id}`);
                        const data = await res.json();
                        return {
                            ...u,
                            doneCount: data.length, // מספר דפים שהושלמו
                            percentage: ((data.length / TOTAL_SHAS_PAGES) * 100).toFixed(2)
                        };
                    });
                    const results = await Promise.all(promises);
                    setStats(results);
                    setLoading(false);
                });
            }, []);

            if (loading) return <div className="text-center p-4">טוען נתונים...</div>;

            return (
                <div className="bg-white p-6 rounded-xl border shadow-sm mt-6">
                    <h2 className="text-xl font-bold mb-4">התקדמות תלמידים</h2>
                    <div className="overflow-x-auto">
                        <table className="w-full text-right text-sm">
                            <thead className="bg-gray-100 text-gray-700">
                                <tr>
                                    <th className="p-3 rounded-tr-lg">שם תלמיד</th>
                                    <th className="p-3">תפקיד</th>
                                    <th className="p-3">דפים שנלמדו</th>
                                    <th className="p-3 rounded-tl-lg">התקדמות בש"ס</th>
                                </tr>
                            </thead>
                            <tbody>
                                {stats.map(s => (
                                    <tr key={s.id} className="border-b hover:bg-slate-50 transition">
                                        <td className="p-3 font-medium">{s.username}</td>
                                        <td className="p-3 text-gray-500">{s.role === 'student' ? 'תלמיד' : s.role === 'admin' ? 'מנהל' : 'מנהל קבוצה'}</td>
                                        <td className="p-3 text-blue-600 font-bold">{s.doneCount}</td>
                                        <td className="p-3">
                                            <div className="flex items-center gap-2">
                                                <div className="w-24 bg-gray-200 rounded-full h-2">
                                                    <div className="bg-emerald-500 h-2 rounded-full" style={{width: `${Math.min(s.percentage, 100)}%`}}></div>
                                                </div>
                                                <span className="text-xs">{s.percentage}%</span>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const AdminPanel = () => {
            const [users, setUsers] = useState([]);
            const [formData, setForm] = useState({username:'', password:'', role:'student'});
            const [tab, setTab] = useState('users'); // 'users' or 'stats'

            useEffect(() => { fetch(`${API_URL}/api/users`).then(r=>r.json()).then(setUsers); }, []);

            const addUser = () => {
                if(!formData.username || !formData.password) return;
                fetch(`${API_URL}/api/users`, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify(formData)
                }).then(r=>r.json()).then(d => {
                    if(d.ok) {
                        alert("משתמש נוסף בהצלחה!");
                        setForm({username:'', password:'', role:'student'});
                        fetch(`${API_URL}/api/users`).then(r=>r.json()).then(setUsers);
                    } else { alert(d.error); }
                });
            };

            return (
                <div>
                    <div className="flex gap-4 mb-4 border-b">
                        <button onClick={()=>setTab('users')} className={`pb-2 px-2 ${tab==='users' ? 'border-b-2 border-blue-600 text-blue-600 font-bold' : 'text-gray-500'}`}>ניהול משתמשים</button>
                        <button onClick={()=>setTab('stats')} className={`pb-2 px-2 ${tab==='stats' ? 'border-b-2 border-blue-600 text-blue-600 font-bold' : 'text-gray-500'}`}>דוחות התקדמות</button>
                    </div>

                    {tab === 'stats' && <AdminStats />}

                    {tab === 'users' && (
                        <div className="bg-white p-6 rounded-xl border shadow-sm">
                            <h2 className="text-xl font-bold mb-4">הוספת משתמש חדש</h2>
                            <div className="flex flex-col md:flex-row gap-3 mb-6 bg-slate-50 p-4 rounded-lg">
                                <input className="border p-2 rounded flex-1" placeholder="שם משתמש" value={formData.username} onChange={e=>setForm({...formData, username:e.target.value})} />
                                <input className="border p-2 rounded flex-1" placeholder="סיסמה" type="password" value={formData.password} onChange={e=>setForm({...formData, password:e.target.value})} />
                                <select className="border p-2 rounded" value={formData.role} onChange={e=>setForm({...formData, role:e.target.value})}>
                                    <option value="student">תלמיד</option>
                                    <option value="group_admin">מנהל קבוצה</option>
                                    <option value="admin">אדמין ראשי</option>
                                </select>
                                <button onClick={addUser} className="bg-emerald-600 text-white px-6 py-2 rounded hover:bg-emerald-700 font-bold">+</button>
                            </div>
                            <h3 className="font-bold mb-2">משתמשים קיימים</h3>
                            <table className="w-full text-right text-sm">
                                <thead className="bg-gray-100"><tr><th className="p-2">שם</th><th className="p-2">תפקיד</th></tr></thead>
                                <tbody>
                                    {users.map(u => <tr key={u.id} className="border-b"><td className="p-2">{u.username}</td><td className="p-2">{u.role}</td></tr>)}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // 4. רכיבי React - אפליקציה ראשית
        // ==========================================

        const Footer = () => (
            <footer className="bg-slate-800 text-slate-400 text-center py-4 text-xs mt-auto">
                <p>פותח על ידי OrelAI <a href="mailto:ubriga@gmail.com" className="text-slate-300 hover:text-white underline">ubriga@gmail.com</a></p>
            </footer>
        );

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('student');
            
            const [loginData, setLoginData] = useState({username:'', password:''});
            const [loginError, setLoginError] = useState(
